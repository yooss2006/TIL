# 38 브라우저의 렌더링 과정

## 브라우저 렌더링 순서

> 1.  렌더링에 필요한 리소스를 요청하고 서버로 응답받는다.
>
> 1.  브라우저의 렌더링엔진은 DOM, CSSOM을 생성하고 이를 결합해 렌더 트리를 생성한다.
> 1.  자바스크립트 엔진은 자바스크립트를 파싱하여 AST를 생성하고 바이트 코드로 변환해서 실행한다. 이때 자바스크립트는 DOM API를 통해 DOM과 CSSOM을 조작할 수 있다. 변경 후 다시 렌더트리로 결합된다.
> 1.  렌더 트리를 기반으로 html 레이아웃의 크기를 브라우저 화면에 html 요소를 페인팅한다.

 </br>

### 1. 렌더링에 필요한 리소스를 요청하고 서버로 응답받는다.

**브라우저란?**

= 필요한 리소스를 서버에 요청하고 응답받아 브라우저에 시각적으로 렌더링

<br/>

<aside>
✍🏼 리소스 : html, css, js, 이미지, 폰트 등
</aside>

</br>

요청 : 주소창에 URL을 입력 → URL의 호스트이름과 DNS를 통해 ip주소로 변환 → ip 주소를 가진 서버에게 요청을 전송

ex) 홈페이지.com은 서버의 루트에 존재하는 정적파일 홈페이지.com/index.html을 요청하는 것과 같다.

</br>

### 2. 브라우저의 렌더링엔진은 DOM, CSSOM을 생성하고 이를 결합해 렌더 트리를 생성한다.

- **dom 생성**

서버로부터 받은 응답은 순수한 텍스트이다.

텍스트를 브라우저가 이해할 수 있는 자료구조인 DOM으로 만드는 것이 **HTML 파싱**이다.

처음부터 한줄씩 파싱하여 DOM을 생성한다.

</br>

<aside>
✍🏼 HTML 파싱의 과정 : 바이트 → 문자 → 토큰 → 노드 → 트리(DOM)
</aside>

</br>

> 토큰 : 문법적 의미를 갖는 최소단위

> 노드 : 토큰을 객체로 변환

> 트리 : 노드가 결합된 자료구조

</br>

- **cssom 생성**

1. DOM을 생성하다가 css를 만나면 DOM 생성을 중단한다.
2. link 태그의 css 파일을 서버에 요청하며 css파일을 응답받는다.
3. html과 동일한 파싱과정을 거쳐 CSSOM을 생성한다.

</br>

<aside>
✍🏼 css 파싱의 과정 : 바이트 → 문자 → 토큰 → 노드 → 트리(CSSOM)
</aside>

</br>

- **렌더트리 생성**

DOM과 CSSOM이 결합되어 렌더트리를 생성한다.

렌더 트리란 렌더링을 위한 트리자료구조로 브라우저 화면에 표시되는 노드만이 구성된다.

렌더트리는 HTML 요소의 레이아웃을 계산하는데 사용되며 브라우저 화면에 픽셀을 렌더링하는 페인트 처리에 입력된다.

</br>

> **리렌더링**

자브스크립트에 의해 노드가 추가, 삭제, html 레이아웃의 크기를 변경을 발생시키는 스타일 변경시 발생한다.

성능에 악영향을 많이 주므로 사용을 자제한다.

</br>

### 3. 자바스크립트 엔진은 자바스크립트를 파싱하여 AST를 생성하고 바이트 코드로 변환해서 실행한다. 이때 자바스크립트는 DOM API를 통해 DOM과 CSSOM을 조작할 수 있다. 변경 후 다시 렌더트리로 결합된다.

</br>

DOM은 html 구조와 정보, html 요소와 스타일을 변경할 수 있는 프로그래밍 인터페이스 **DOM API**를 제공한다.

1. css와 마찬가지로 dom 생성 중 javascript관련 태그를 만나면 dom 생성을 일시 중단한다.
2. 서버에 js 파일을 요청하고 자바스크립트 엔진이 제어권을 가진다.
3. 파싱과 실행이 종료되면 렌더링 엔진으로 제어권을 넘겨 DOM 생성을 재개한다.

</br>

**자바스크립트 엔진**

자바스크립트 코드를 파싱하여 cpu가 이해할 수 있는 저수준의 언어로 변환, 실행

자바스크립트를 해석하여 AST(추상적 구문트리)를 생성한다.

AST를 기반으로 인터프리터가 실행가능한 바이트 코드를 생성하여 실행한다.

</br>

**리플로우와 리페인트의 차이**

자바스크립트 코드에 DOM이나 CSSOM을 변경하는 DOM API가 사용된 경우 변경 사항을 다시 렌더트리로 결합하고 레이아웃과 페인팅 과정을 다시 하는 것

- **리플로우** : 레이아웃 계산을 다시하는 것 , 노드 추가 및 삭제, 요소 크기 및 위치변경과 같은 레이아웃에 영향을 주는 변경 발생

- **리페인트** : 재결합된 렌더트리를 기반으로 다시 페인트한다.

</br>

### async/defer 어트리뷰트

src 어트리뷰트를 통해 자바스크립트 파일을 로드하는 경우에 사용

이를 사용시 HTML의 파싱과 자바스크립트 파일의 로드가 동시에 진행된다.

- **async 어트리뷰트**

자바스크립트의 파싱과 실행이 자바스크립트 파일이 로드가 완료된 직후에 진행되며 이때 HTML 파싱이 중단된다.

로드 직후에 실행되므로 순서가 보장되지 않음

- **defer 어트리뷰트**

dom생성이 완료된 직후 진행된다.

</br>

### 번외 : http

브라우저와 서버가 통신하기 위한 프로토콜

http/1.1 : 커넥션 하나당 하나의 요청과 응답만 처리, 다중요청, 응답이 불가능해 요청할 리소스가 많다면 응답시간이 증가

http/2 : 커넥션 하나당 여러개의 요청 응답이 가능하다. 1.1보다 50%정도 빠르다.
